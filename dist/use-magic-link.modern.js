import{useState as n,useEffect as e}from"react";import t from"event-emitter";import i from"isomorphic-unfetch";import o from"ms";import{Sema as a}from"async-sema";const l=new t;let r=null,c=null,u=null;async function s(n){return u||(n&&r?(u=new r(n),u):(c||(console.log("Loading Magic"),c=window.document.createElement("script"),c.async=!0,c.src="https://cdn.jsdelivr.net/npm/magic-sdk/dist/magic.js",c.id="magic-link-sdk",c.onload=()=>{r=window.Magic,l.emit("loaded")},document.head.appendChild(c)),n?new Promise(e=>{l.once("loaded",()=>{u||(u=new r(n)),e(u)})}):void 0))}const d=new a(1),g=new a(1),f=new t;let m=null,w=null;async function h(n){await d.acquire();try{if(w&&w.expiredAt>Date.now())return w.token;const e=await s(n),t=await e.user.getIdToken();return y(t),t}finally{d.release()}}function y(n,e=o("15min")){w={token:n,expiredAt:Date.now()+e-o("1min")}}"undefined"!=typeof window&&s();export default function(t){if(!t)throw new Error("Magic Link publishableKey required as the first argument");const[o,a]=n(null!==m&&m),[l,r]=n(null===m),[c,u]=n(null),[d,p]=n(!1),[k,I]=n(!1);return e(()=>{function n(n){a(n)}return m||async function(n){await g.acquire();try{if(null!==m)return m;await h(n),m=!0}catch(n){m=!1}finally{g.release()}return m}(t).then(n=>{a(n)}).then(()=>r(!1)),f.on("loggedIn",n),()=>{f.off("loggedIn",n)}},[m]),{loggedIn:o,loading:l,error:c,loggingIn:d,loggingOut:k,login:async function(n){u(null),p(!0);try{const e=(await s(t)).auth.loginWithMagicLink({email:n});m=!0,y(e),f.emit("loggedIn",!0),a(!0)}catch(n){u(n)}finally{p(!1)}},logout:async function(){u(null),I(!0);try{const n=await s(t);await n.user.logout(),m=null,w=null,f.emit("loggedIn",!1),a(!1)}catch(n){u(n)}finally{I(!1)}return null===m},fetch:async function(n,e={}){const o=await h(t);return o&&(e.headers=e.headers||{},e.headers.Authorization="Bearer "+o),i(n,e)},loginEvents:f}}
//# sourceMappingURL=use-magic-link.modern.js.map
