import{useState as n,useEffect as e}from"react";import t from"event-emitter";import i from"isomorphic-unfetch";import{Sema as a}from"async-sema";const o=new t;let l=null,r=null,c=null;async function u(n){return c||(n&&l?(c=new l(n),c):(r||(r=window.document.createElement("script"),r.async=!0,r.src="https://cdn.jsdelivr.net/npm/magic-sdk/dist/magic.js",r.id="magic-link-sdk",r.onload=()=>{l=window.Magic,o.emit("loaded")},document.head.appendChild(r)),n?new Promise(e=>{o.once("loaded",()=>{c||(c=new l(n)),e(c)})}):void 0))}const s=new a(1),d=new a(1),g=new t;let f=null,w=null,m=null;async function h(n){await s.acquire();try{if(w&&w.expiredAt>Date.now())return w.token;m=await u(n);const e=await m.user.getIdToken();return y(e),e}finally{s.release()}}function y(n,e=9e5){w={token:n,expiredAt:Date.now()+e-6e4}}"undefined"!=typeof window&&u();export default function(t){if(!t)throw new Error("Magic Link publishableKey required as the first argument");const[a,o]=n(null!==f&&f),[l,r]=n(null===f),[c,s]=n(null),[p,k]=n(!1),[I,v]=n(!1);return e(()=>{function n(n){o(n)}return f||async function(n){await d.acquire();try{if(null!==f)return f;await h(n),f=!0}catch(n){f=!1}finally{d.release()}return f}(t).then(n=>{o(n)}).then(()=>r(!1)),g.on("loggedIn",n),()=>{g.off("loggedIn",n)}},[f]),{loggedIn:a,loading:l,error:c,loggingIn:p,loggingOut:I,login:async function(n){s(null),k(!0);try{const e=await u(t),i=await e.auth.loginWithMagicLink({email:n});f=!0,y(i),g.emit("loggedIn",!0),o(!0)}catch(n){s(n)}finally{k(!1)}},logout:async function(){s(null),v(!0);try{const n=await u(t);await n.user.logout(),f=null,w=null,g.emit("loggedIn",!1),o(!1)}catch(n){s(n)}finally{v(!1)}return null===f},fetch:async function(n,e={}){const a=await h(t);return a&&(e.headers=e.headers||{},e.headers.Authorization="Bearer "+a),i(n,e)},loginEvents:g,magic:m}}
//# sourceMappingURL=use-magic-link.modern.js.map
