{"version":3,"file":"use-magic-link.module.js","sources":["../src/load-magic-link.js","../src/use-magic-link.js"],"sourcesContent":["import EventEmitter from 'event-emitter';\n\nconst events = new EventEmitter();\nlet MagicSDK = null;\nlet script = null;\nlet sdk = null;\n\nexport default async function loadMagicLink(key) {\n    if (sdk) {\n        return sdk;\n    }\n\n    if (key && MagicSDK) {\n        sdk = new MagicSDK(key)\n        return sdk;\n    }\n\n    if (!script) {\n        script = window.document.createElement('script');\n        script.async = true;\n        script.src = 'https://cdn.jsdelivr.net/npm/magic-sdk/dist/magic.js';\n        script.id = 'magic-link-sdk';\n        script.onload = () => {\n            MagicSDK = window.Magic;\n            events.emit('loaded');\n        }\n        \n        document.head.appendChild(script);\n    }\n\n    if (!key) {\n        return\n    }\n\n    return new Promise((resolve) => {\n        events.once('loaded', () => {\n            if (sdk) {\n                resolve(sdk)\n                return;\n            }\n            \n            sdk = new MagicSDK(key);\n            resolve(sdk);\n        })\n    })\n}","import { useState, useEffect } from 'react'\nimport EventEmitter from 'event-emitter'\nimport unfetch from 'isomorphic-unfetch'\nimport { Sema } from 'async-sema'\nimport loadMagicLink from './load-magic-link'\n\nconst tokenSema = new Sema(1)\nconst loggedInSema = new Sema(1)\nconst loginEvents = new EventEmitter()\n\nconst ONE_MINUTE = 1000 * 60;\n\nlet currentLoginState = null\nlet currentToken = null\nlet magic = null\n\nif (typeof window !== 'undefined') {\n  loadMagicLink()\n}\n\nasync function getMagicToken (magicLinkKey) {\n  await tokenSema.acquire()\n  try {\n    if (currentToken && currentToken.expiredAt > Date.now()) {\n      return currentToken.token\n    }\n\n    magic = await loadMagicLink(magicLinkKey);\n    const token = await magic.user.getIdToken()\n    setToken(token)\n    return token\n  } finally {\n    tokenSema.release()\n  }\n}\n\nasync function isLoggedIn (magicLinkKey) {\n  await loggedInSema.acquire()\n\n  try {\n    if (currentLoginState !== null) {\n      return currentLoginState\n    }\n\n    await getMagicToken(magicLinkKey)\n    currentLoginState = true\n  } catch (err) {\n    currentLoginState = false\n  } finally {\n    loggedInSema.release()\n  }\n\n  return currentLoginState\n}\n\nfunction setToken (token, lifespan = ONE_MINUTE * 15) {\n  currentToken = {\n    token,\n    expiredAt: Date.now() + lifespan - ONE_MINUTE\n  }\n}\n\nexport default function useAuth (magicLinkKey) {\n  if (!magicLinkKey) {\n    throw new Error('Magic Link publishableKey required as the first argument')\n  }\n\n  const [loggedIn, setLoggedIn] = useState(currentLoginState !== null ? currentLoginState : false)\n  const [loading, setLoading] = useState(currentLoginState === null)\n  const [error, setError] = useState(null)\n  const [loggingIn, setLoggingIn] = useState(false)\n  const [loggingOut, setLoggingOut] = useState(false)\n\n  async function login (email) {\n    setError(null)\n    setLoggingIn(true)\n\n    try {\n      const magic = await loadMagicLink(magicLinkKey);\n      const token = await magic.auth.loginWithMagicLink({ email })\n      currentLoginState = true\n      setToken(token)\n      loginEvents.emit('loggedIn', true)\n      setLoggedIn(true)\n    } catch(err) {\n      setError(err);\n    } finally {\n      setLoggingIn(false)\n    }\n  }\n\n  async function logout () {\n    setError(null)\n    setLoggingOut(true)\n\n    try {\n      const magic = await loadMagicLink(magicLinkKey);\n      await magic.user.logout()\n      currentLoginState = null\n      currentToken = null\n      loginEvents.emit('loggedIn', false)\n      setLoggedIn(false)\n    } catch (err) {\n      setError(err)\n    } finally {\n      setLoggingOut(false)\n    }\n\n    return currentLoginState === null\n  }\n\n  async function fetch (url, opts = {}) {\n    const token = await getMagicToken(magicLinkKey)\n    if (token) {\n      opts.headers = opts.headers || {}\n      opts.headers.Authorization = `Bearer ${token}`\n    }\n\n    return unfetch(url, opts)\n  }\n\n  useEffect(() => {\n    if (!currentLoginState) {\n      isLoggedIn(magicLinkKey)\n        .then((loginState) => {\n          setLoggedIn(loginState)\n        })\n        .then(() => setLoading(false))\n    }\n\n    function watchLoggedIn (state) {\n      setLoggedIn(state)\n    }\n    loginEvents.on('loggedIn', watchLoggedIn)\n\n    return () => {\n      loginEvents.off('loggedIn', watchLoggedIn)\n    }\n  }, [currentLoginState])\n\n  return {\n    loggedIn,\n    loading,\n    error,\n    loggingIn,\n    loggingOut,\n    login,\n    logout,\n    fetch,\n    loginEvents,\n    magic\n  }\n}\n"],"names":["loadMagicLink","key","sdk","MagicSDK","script","window","document","createElement","async","src","id","onload","Magic","events","emit","head","appendChild","Promise","resolve","once","EventEmitter","_catch","body","recover","result","e","then","_finallyRethrows","finalizer","bind","getMagicToken","magicLinkKey","tokenSema","acquire","currentToken","expiredAt","Date","now","token","magic","user","getIdToken","setToken","release","Sema","loggedInSema","loginEvents","currentLoginState","lifespan","ONE_MINUTE","Error","useState","loggedIn","setLoggedIn","loading","setLoading","error","setError","loggingIn","setLoggingIn","loggingOut","setLoggingOut","useEffect","watchLoggedIn","state","isLoggedIn","loginState","on","off","login","email","auth","loginWithMagicLink","err","logout","fetch","url","opts","headers","Authorization","unfetch"],"mappings":"qJAO8BA,WAAcC,OACxC,OAAIC,kBACOA,GAGPD,GAAOE,GACPD,EAAM,IAAIC,EAASF,mBACZC,KAGNE,KACDA,EAASC,OAAOC,SAASC,cAAc,WAChCC,OAAQ,EACfJ,EAAOK,IAAM,uDACbL,EAAOM,GAAK,iBACZN,EAAOO,OAAS,WACZR,EAAWE,OAAOO,MAClBC,EAAOC,KAAK,WAGhBR,SAASS,KAAKC,YAAYZ,IAGzBH,kBAIE,IAAIgB,QAAQ,SAACC,GAChBL,EAAOM,KAAK,SAAU,WACdjB,IAKJA,EAAM,IAAIC,EAASF,IAJfiB,EAAQhB,+DAnClBW,EAAS,IAAIO,EACfjB,EAAW,KACXC,EAAS,KACTF,EAAM,KC6iBH,SAASmB,EAAOC,EAAMC,GAC5B,IACC,IAAIC,EAASF,IACZ,MAAMG,GACP,OAAOF,EAAQE,GAEhB,OAAID,GAAUA,EAAOE,KACbF,EAAOE,UAAK,EAAQH,GAErBC,EAID,SAASG,EAAiBL,EAAMM,GACtC,IACC,IAAIJ,EAASF,IACZ,MAAOG,GACR,OAAOG,GAAU,EAAMH,GAExB,OAAID,GAAUA,EAAOE,KACbF,EAAOE,KAAKE,EAAUC,KAAK,MAAM,GAAQD,EAAUC,KAAK,MAAM,IAE/DD,GAAU,EAAOJ,OApjBVM,WAAeC,8BACtBC,EAAUC,sDAEVC,GAAgBA,EAAaC,UAAYC,KAAKC,MACzCH,EAAaI,sBAGRtC,EAAc+B,qBAL1B,OAKFQ,oBACoBA,EAAMC,KAAKC,4BAAzBH,GAEN,OADAI,EAASJ,GACFA,qBAViC,GAYxCN,EAAUW,qEA1BRX,EAAY,IAAIY,EAAK,GACrBC,EAAe,IAAID,EAAK,GACxBE,EAAc,IAAI1B,EAIpB2B,EAAoB,KACpBb,EAAe,KACfK,EAAQ,KAyCZ,SAASG,EAAUJ,EAAOU,YAAAA,IAAAA,EAAWC,KACnCf,EAAe,CACbI,MAAAA,EACAH,UAAWC,KAAKC,MAAQW,EAhDT,KAMG,oBAAX3C,QACTL,4BA6C+B+B,GAC/B,IAAKA,EACH,UAAUmB,MAAM,4DAF2B,MAKbC,EAA+B,OAAtBJ,GAA6BA,GAA/DK,OAAUC,SACaF,EAA+B,OAAtBJ,GAAhCO,OAASC,SACUJ,EAAS,MAA5BK,OAAOC,SACoBN,GAAS,GAApCO,OAAWC,SACkBR,GAAS,GAAtCS,OAAYC,OAqEnB,OAnBAC,EAAU,WASR,SAASC,EAAeC,GACtBX,EAAYW,GAId,OAbKjB,YAtFkBhB,8BACnBc,EAAaZ,oEAGjB,OAA0B,OAAtBc,OACKA,mBAGHjB,EAAcC,oBACpBgB,GAAoB,gBAEpBA,GAAoB,mBAXiB,GAarCF,EAAaF,8EAGRI,QAAAA,uCAuEHkB,CAAWlC,GACRL,KAAK,SAACwC,GACLb,EAAYa,KAEbxC,KAAK,kBAAM6B,GAAW,KAM3BT,EAAYqB,GAAG,WAAYJ,cAGzBjB,EAAYsB,IAAI,WAAYL,KAE7B,CAAChB,IAEG,CACLK,SAAAA,EACAE,QAAAA,EACAE,MAAAA,EACAE,UAAAA,EACAE,WAAAA,EACAS,eAzEoBC,OACpBb,EAAS,MACTE,GAAa,GAFc,8DAKL3D,EAAc+B,kBAA5BQ,0BACcA,EAAMgC,KAAKC,mBAAmB,CAAEF,MAAAA,mBAA9ChC,GACNS,GAAoB,EACpBL,EAASJ,GACTQ,EAAYhC,KAAK,YAAY,GAC7BuC,GAAY,iBACNoB,GACNhB,EAASgB,oBAZgB,GAczBd,GAAa,sFAzB4B,oCAqF3Ce,sBAvDAjB,EAAS,MACTI,GAAc,GAFS,8DAKD7D,EAAc+B,kBAA5BQ,0BACAA,EAAMC,KAAKkC,0BACjB3B,EAAoB,KACpBb,EAAe,KACfY,EAAYhC,KAAK,YAAY,GAC7BuC,GAAY,iBACLoB,GACPhB,EAASgB,oBAZY,GAcrBZ,GAAc,2EAGhB,OAA6B,OAAtBd,IAAsB,OAAtBA,GA9CoC,oCAsF3C4B,eArCoBC,EAAKC,YAAAA,IAAAA,EAAO,+BACZ/C,EAAcC,kBAA5BO,GAMN,OALIA,IACFuC,EAAKC,QAAUD,EAAKC,SAAW,GAC/BD,EAAKC,QAAQC,wBAA0BzC,GAGlC0C,EAAQJ,EAAKC,KAxDuB,oCAuF3C/B,YAAAA,EACAP,MAAAA"}