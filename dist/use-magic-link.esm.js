import{useState as n,useEffect as e}from"react";import t from"event-emitter";import r from"isomorphic-unfetch";import o from"ms";import{Sema as u}from"async-sema";function i(n,e){try{var t=n()}catch(n){return e(n)}return t&&t.then?t.then(void 0,e):t}function c(n,e){try{var t=n()}catch(n){return e(!0,n)}return t&&t.then?t.then(e.bind(null,!1),e.bind(null,!0)):e(!1,t)}var l,f=function(){try{return Promise.resolve(h.acquire()).then(function(){return c(function(){return g&&g.expiredAt>Date.now()?g.token:Promise.resolve(l.user.getIdToken()).then(function(n){return d(n),n})},function(n,e){if(h.release(),n)throw e;return e})})}catch(n){return Promise.reject(n)}};"undefined"!=typeof window&&(l=new Magic("pk_live_BF2003EFDD157AF4"));var h=new u(1),a=new u(1),m=new t,s=null,g=null;function d(n,e){void 0===e&&(e=o("15min")),g={token:n,expiredAt:Date.now()+e-o("1min")}}export default function(){var t=n(null!==s&&s),o=t[0],u=t[1],h=n(null===s),v=h[0],p=h[1],w=n(null),P=w[0],y=w[1],I=n(!1),k=I[0],j=I[1],A=n(!1),D=A[0],x=A[1];return e(function(){function n(n){u(n)}return s||function(){try{return Promise.resolve(a.acquire()).then(function(){var n,e=c(function(){return i(function(){return null!==s?(n=1,s):Promise.resolve(f()).then(function(){s=!0})},function(){s=!1})},function(n,e){if(a.release(),n)throw e;return e});return e&&e.then?e.then(function(e){return n?e:s}):n?e:s})}catch(n){return Promise.reject(n)}}().then(function(n){u(n)}).then(function(){return p(!1)}),m.on("loggedIn",n),function(){m.off("loggedIn",n)}},[s]),{loggedIn:o,loading:v,error:P,loggingIn:k,loggingOut:D,login:function(n){y(null),j(!0),l.auth.loginWithMagicLink({email:n}).then(function(n){s=!0,d(n),m.emit("loggedIn",!0),u(!0)},y).then(function(){return j(!1)})},logout:function(){try{y(null),x(!0);var n=c(function(){return i(function(){return Promise.resolve(l.user.logout()).then(function(){s=null,g=null,m.emit("loggedIn",!1),u(!1)})},function(n){y(n)})},function(n,e){if(x(!1),n)throw e;return e});return Promise.resolve(n&&n.then?n.then(function(){return null===s}):null===s)}catch(n){return Promise.reject(n)}},fetch:function(n,e){void 0===e&&(e={});try{return Promise.resolve(f()).then(function(t){return t&&(e.headers=e.headers||{},e.headers.Authorization="Bearer "+t),r(n,e)})}catch(n){return Promise.reject(n)}},loginEvents:m}}
//# sourceMappingURL=use-magic-link.esm.js.map
