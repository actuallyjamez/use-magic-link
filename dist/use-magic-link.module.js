import{useState as n,useEffect as e}from"react";import r from"event-emitter";import t from"isomorphic-unfetch";import o from"ms";import{Sema as i}from"async-sema";var u=function(n){try{return s?Promise.resolve(s):n&&l?(s=new l(n),Promise.resolve(s)):(f||(console.log("Loading Magic"),(f=window.document.createElement("script")).async=!0,f.src="https://cdn.jsdelivr.net/npm/magic-sdk/dist/magic.js",f.id="magic-link-sdk",f.onload=function(){l=window.Magic,c.emit("loaded")},document.head.appendChild(f)),n?Promise.resolve(new Promise(function(e){c.once("loaded",function(){s||(s=new l(n)),e(s)})})):Promise.resolve())}catch(n){return Promise.reject(n)}},c=new r,l=null,f=null,s=null;function a(n,e){try{var r=n()}catch(n){return e(n)}return r&&r.then?r.then(void 0,e):r}function m(n,e){try{var r=n()}catch(n){return e(!0,n)}return r&&r.then?r.then(e.bind(null,!1),e.bind(null,!0)):e(!1,r)}var h=function(n){try{return Promise.resolve(d.acquire()).then(function(){return m(function(){return w&&w.expiredAt>Date.now()?w.token:Promise.resolve(u(n)).then(function(n){return Promise.resolve(n.user.getIdToken()).then(function(n){return p(n),n})})},function(n,e){if(d.release(),n)throw e;return e})})}catch(n){return Promise.reject(n)}},d=new i(1),g=new i(1),v=new r,P=null,w=null;function p(n,e){void 0===e&&(e=o("15min")),w={token:n,expiredAt:Date.now()+e-o("1min")}}"undefined"!=typeof window&&u();export default function(r){if(!r)throw new Error("Magic Link publishableKey required as the first argument");var o=n(null!==P&&P),i=o[0],c=o[1],l=n(null===P),f=l[0],s=l[1],d=n(null),y=d[0],j=d[1],k=n(!1),I=k[0],b=k[1],M=n(!1),q=M[0],x=M[1];return e(function(){function n(n){c(n)}return P||function(n){try{return Promise.resolve(g.acquire()).then(function(){var e,r=m(function(){return a(function(){return null!==P?(e=1,P):Promise.resolve(h(n)).then(function(){P=!0})},function(){P=!1})},function(n,e){if(g.release(),n)throw e;return e});return r&&r.then?r.then(function(n){return e?n:P}):e?r:P})}catch(n){return Promise.reject(n)}}(r).then(function(n){c(n)}).then(function(){return s(!1)}),v.on("loggedIn",n),function(){v.off("loggedIn",n)}},[P]),{loggedIn:i,loading:f,error:y,loggingIn:I,loggingOut:q,login:function(n){try{j(null),b(!0);var e=m(function(){return a(function(){return Promise.resolve(u(r)).then(function(e){var r=e.auth.loginWithMagicLink({email:n});P=!0,p(r),v.emit("loggedIn",!0),c(!0)})},function(n){j(n)})},function(n,e){if(b(!1),n)throw e;return e});return Promise.resolve(e&&e.then?e.then(function(){}):void 0)}catch(n){return Promise.reject(n)}},logout:function(){try{j(null),x(!0);var n=m(function(){return a(function(){return Promise.resolve(u(r)).then(function(n){return Promise.resolve(n.user.logout()).then(function(){P=null,w=null,v.emit("loggedIn",!1),c(!1)})})},function(n){j(n)})},function(n,e){if(x(!1),n)throw e;return e});return Promise.resolve(n&&n.then?n.then(function(){return null===P}):null===P)}catch(n){return Promise.reject(n)}},fetch:function(n,e){void 0===e&&(e={});try{return Promise.resolve(h(r)).then(function(r){return r&&(e.headers=e.headers||{},e.headers.Authorization="Bearer "+r),t(n,e)})}catch(n){return Promise.reject(n)}},loginEvents:v}}
//# sourceMappingURL=use-magic-link.module.js.map
