import{useState as n,useEffect as e}from"react";import r from"event-emitter";import t from"isomorphic-unfetch";import{Sema as o}from"async-sema";var i=function(n){try{return f?Promise.resolve(f):n&&c?(f=new c(n),Promise.resolve(f)):(l||((l=window.document.createElement("script")).async=!0,l.src="https://cdn.jsdelivr.net/npm/magic-sdk/dist/magic.js",l.id="magic-link-sdk",l.onload=function(){c=window.Magic,u.emit("loaded")},document.head.appendChild(l)),n?Promise.resolve(new Promise(function(e){u.once("loaded",function(){f||(f=new c(n)),e(f)})})):Promise.resolve())}catch(n){return Promise.reject(n)}},u=new r,c=null,l=null,f=null;function s(n,e){try{var r=n()}catch(n){return e(n)}return r&&r.then?r.then(void 0,e):r}function a(n,e){try{var r=n()}catch(n){return e(!0,n)}return r&&r.then?r.then(e.bind(null,!1),e.bind(null,!0)):e(!1,r)}var h=function(n){try{return Promise.resolve(m.acquire()).then(function(){return a(function(){return P&&P.expiredAt>Date.now()?P.token:Promise.resolve(i(n)).then(function(n){return Promise.resolve(n.user.getIdToken()).then(function(n){return w(n),n})})},function(n,e){if(m.release(),n)throw e;return e})})}catch(n){return Promise.reject(n)}},m=new o(1),d=new o(1),v=new r,g=null,P=null;function w(n,e){void 0===e&&(e=9e5),P={token:n,expiredAt:Date.now()+e-6e4}}"undefined"!=typeof window&&i();export default function(r){if(!r)throw new Error("Magic Link publishableKey required as the first argument");var o=n(null!==g&&g),u=o[0],c=o[1],l=n(null===g),f=l[0],m=l[1],p=n(null),y=p[0],j=p[1],k=n(!1),I=k[0],b=k[1],q=n(!1),x=q[0],A=q[1];return e(function(){function n(n){c(n)}return g||function(n){try{return Promise.resolve(d.acquire()).then(function(){var e,r=a(function(){return s(function(){return null!==g?(e=1,g):Promise.resolve(h(n)).then(function(){g=!0})},function(){g=!1})},function(n,e){if(d.release(),n)throw e;return e});return r&&r.then?r.then(function(n){return e?n:g}):e?r:g})}catch(n){return Promise.reject(n)}}(r).then(function(n){c(n)}).then(function(){return m(!1)}),v.on("loggedIn",n),function(){v.off("loggedIn",n)}},[g]),{loggedIn:u,loading:f,error:y,loggingIn:I,loggingOut:x,login:function(n){try{j(null),b(!0);var e=a(function(){return s(function(){return Promise.resolve(i(r)).then(function(e){return Promise.resolve(e.auth.loginWithMagicLink({email:n})).then(function(n){g=!0,w(n),v.emit("loggedIn",!0),c(!0)})})},function(n){j(n)})},function(n,e){if(b(!1),n)throw e;return e});return Promise.resolve(e&&e.then?e.then(function(){}):void 0)}catch(n){return Promise.reject(n)}},logout:function(){try{j(null),A(!0);var n=a(function(){return s(function(){return Promise.resolve(i(r)).then(function(n){return Promise.resolve(n.user.logout()).then(function(){g=null,P=null,v.emit("loggedIn",!1),c(!1)})})},function(n){j(n)})},function(n,e){if(A(!1),n)throw e;return e});return Promise.resolve(n&&n.then?n.then(function(){return null===g}):null===g)}catch(n){return Promise.reject(n)}},fetch:function(n,e){void 0===e&&(e={});try{return Promise.resolve(h(r)).then(function(r){return r&&(e.headers=e.headers||{},e.headers.Authorization="Bearer "+r),t(n,e)})}catch(n){return Promise.reject(n)}},loginEvents:v}}
//# sourceMappingURL=use-magic-link.module.js.map
